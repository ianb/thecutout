
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The Cut-Out: a no-opinion syncing system for your Javascript/HTML applications &mdash; The Cut-Out</title>
    
    <link rel="stylesheet" href="_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="The Cut-Out" href="#" />
<!--<link rel="stylesheet" href="https://static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />-->
<link href='http://fonts.googleapis.com/css?family=Rosarivo' rel='stylesheet' type='text/css'>
<!--[if lte IE 6]>
<link rel="stylesheet" href="_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="_static/pylons.ico"/>

  </head>
  <body>




<a href="https://github.com/ianb/thecutout"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/camo.github.com/7afbc8b248c68eb468279e8c17986ad46549fb71/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub"></a>


<div class="header-small">
        <h1><a href="#">The Cut-Out</a></h1>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
    	<li><a href="#">The Cut-Out</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <p>A <a class="reference external" href="http://en.wikipedia.org/wiki/Cut-out_(espionage%29">&#8220;Cut-Out&#8221;</a>, in espionage terms, is a trusted intermediary who facilitates the exchange of information between agents.</p>
<p>This project is a server and accompanying client library to provide an intermediary to store and communication information between browser-based applications (e.g., applications that use <tt class="code docutils literal"><span class="pre">localStorage</span></tt> or <tt class="code docutils literal"><span class="pre">IndexedDB</span></tt> as their primary storage).</p>
<div class="section" id="quick-start">
<h1>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h1>
<p>First, start the server.  It should work to run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">dev-server.py</span></tt> - all the prerequesites are included in <tt class="docutils literal"><span class="pre">vendor/</span></tt></p>
<p>This will start the server up at <tt class="docutils literal"><span class="pre">http://localhost:8088/sync/</span></tt> - see <tt class="docutils literal"><span class="pre">-h</span></tt> for other options.  Note that <tt class="docutils literal"><span class="pre">selftest-server.py</span></tt> is for running the tests, so you don&#8217;t want that one.  You can also use <tt class="docutils literal"><span class="pre">python</span> <span class="pre">dev-server.py</span> <span class="pre">my-app/</span></tt> which will serve up the files in <tt class="docutils literal"><span class="pre">my-app/</span></tt> on the root and put the server in <tt class="docutils literal"><span class="pre">/sync/</span></tt> (and the client library in <tt class="docutils literal"><span class="pre">/sync/syncclient.js</span></tt>).</p>
<p>Next, include this in your page:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://localhost:8088/sync/syncclient.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://browserid.org/include.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div>
</div>
<p>And create an object to integrate with your stored data:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">MyAppData</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">getPendingObjects</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">object</span> <span class="k">in</span> <span class="nx">objectsThatArentSaved</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">object</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">objectsThatWereDeleted</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">deleted</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">objectsSaved</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">objects</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">objects</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">confirmDelete</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">confirmSaved</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">objectsReceived</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">objects</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">objects</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">deleteObject</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">createObject</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">onupdate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span>
<span class="nx">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sync</span><span class="p">(</span><span class="nx">MyAppData</span><span class="p">);</span>
<span class="nx">sync</span><span class="p">.</span><span class="nx">watch</span><span class="p">({</span>
  <span class="nx">onlogin</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">onlogout</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;login&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">request</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// and call MyAppData.onupdate() whenever you update your objects</span>
</pre></div>
</div>
<p>That&#8217;s it!  You also have a login system!</p>
</div>
<div class="section" id="library">
<h1>Library<a class="headerlink" href="#library" title="Permalink to this headline">¶</a></h1>
<p>The library is present in <tt class="code docutils literal"><span class="pre">syncclient.js</span></tt>.  While there are several internals that you could poke around with, the &#8220;simple&#8221; version is just one function, <tt class="docutils literal"><span class="pre">new</span> <span class="pre">Sync(appData,</span> <span class="pre">{options})</span></tt> which returns a sync object.</p>
<div class="section" id="appdata">
<h2>appData<a class="headerlink" href="#appdata" title="Permalink to this headline">¶</a></h2>
<p>This is the object that tells the sync service how to interact with your data.  This object has three important methods:</p>
<div class="section" id="appdata-getpendingobjects-callback">
<h3><tt class="code docutils literal"><span class="pre">appData.getPendingObjects(callback)</span></tt><a class="headerlink" href="#appdata-getpendingobjects-callback" title="Permalink to this headline">¶</a></h3>
<p>This should return all the <em>new</em> objects in your application.  You have to keep track yourself of when objects have been saved before, or if they&#8217;ve been updated, or if they&#8217;ve been deleted.</p>
<p>Your function should call <tt class="docutils literal"><span class="pre">callback(null,</span> <span class="pre">[objects])</span></tt> (the objects could be an empty list).  The return value does not matter.</p>
<p>Each object should look like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;some stable id&quot;</span><span class="p">,</span>
  <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;type-of-object&quot;</span><span class="p">,</span>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">some</span> <span class="nx">data</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="code docutils literal"><span class="pre">id</span></tt> is something you should make yourself, but it should distinguish between updates and new objects.  Creating an ID with a UUID is perfectly fine, so long as you make that ID persistent.  The id should be a string or integer.</p>
<p>The <tt class="code docutils literal"><span class="pre">type</span></tt> is just the kind of the object.  It should be a string.</p>
<p>The <tt class="code docutils literal"><span class="pre">data</span></tt> is the actual data.  Some JSONable object.</p>
<p>If you have a deleted object, you should represent it like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;some stable id&quot;</span><span class="p">,</span>
  <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;type-of-object&quot;</span><span class="p">,</span>
  <span class="nx">deleted</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that having returned these objects, they may not get used!</p>
</div>
<div class="section" id="appdata-objectssaved-objects">
<h3><tt class="code docutils literal"><span class="pre">appData.objectsSaved(objects)</span></tt><a class="headerlink" href="#appdata-objectssaved-objects" title="Permalink to this headline">¶</a></h3>
<p>This method indicates that the objects (as returned from <tt class="code docutils literal"><span class="pre">getPendingObjects</span></tt> have actually been saved.  You should store something with the objects showing that they are saved, so you don&#8217;t return them in future calls to <tt class="code docutils literal"><span class="pre">getPendingObjects</span></tt>.</p>
<p>Note that attempts to upload objects can fail, so the results of <tt class="code docutils literal"><span class="pre">getPendingObjects</span></tt> may be discarded and retrieved later for another attempt.  Typically such a case will result in a sequence of getPendingObjects, objectsReceived, getPendingObjects again, and finally objectsSaved.</p>
<p>Note if you use blobs, you should check for the <tt class="code docutils literal"><span class="pre">href</span></tt> of the object, which will have been set after saving.  You can still keep the source of the blob around if you want, or remove it and rely on the remote/linked blob.</p>
</div>
<div class="section" id="appdata-objectsreceived-objects">
<h3><tt class="code docutils literal"><span class="pre">appData.objectsReceived(objects)</span></tt><a class="headerlink" href="#appdata-objectsreceived-objects" title="Permalink to this headline">¶</a></h3>
<p>This happens when a new object has appeared on the server.  The objects are formatted just as above, and probably came from another instance of your application.</p>
<p>These objects can include updates, new objects, and deletes.</p>
</div>
<div class="section" id="appdata-status-message">
<h3><tt class="code docutils literal"><span class="pre">appData.status(message)</span></tt><a class="headerlink" href="#appdata-status-message" title="Permalink to this headline">¶</a></h3>
<p>This not-really-documented optional method is called to indicate things that are happening with the sync service.  You could maybe use it to indicate the sync status in the UI somewhere.</p>
</div>
<div class="section" id="appdata-resetsaved">
<h3><tt class="code docutils literal"><span class="pre">appData.resetSaved()</span></tt><a class="headerlink" href="#appdata-resetsaved" title="Permalink to this headline">¶</a></h3>
<p>This is called when the server is switched out somehow, and you should erase all information about what objects have been saved in the past. This is done before starting a new from-scratch sync.</p>
</div>
<div class="section" id="appdata-reportobjecterrors">
<h3><tt class="code docutils literal"><span class="pre">appData.reportObjectErrors()</span></tt><a class="headerlink" href="#appdata-reportobjecterrors" title="Permalink to this headline">¶</a></h3>
<p>This optional method is called if <tt class="code docutils literal"><span class="pre">getPendingObjects</span></tt> returns a bad object.</p>
</div>
<div class="section" id="appdata-onupdate">
<h3><tt class="code docutils literal"><span class="pre">appData.onupdate</span></tt><a class="headerlink" href="#appdata-onupdate" title="Permalink to this headline">¶</a></h3>
<p>This attribute will be set by the sync service, so long as the attribute exists (if you don&#8217;t define it, it won&#8217;t be set - even setting it to <tt class="code docutils literal"><span class="pre">null</span></tt> is sufficient).  You are encouraged, but not required, to call this when the data changes.  This will cause the sync process to trigger soon, updating the server with the new data.</p>
</div>
</div>
<div class="section" id="options">
<h2>options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h2>
<p>There are a couple options to <tt class="docutils literal"><span class="pre">Sync(appData,</span> <span class="pre">{options})</span></tt>:</p>
<p><tt class="code docutils literal"><span class="pre">assertion</span></tt>: a browerid/persona assertion to login with.  If you don&#8217;t provide this, then the service is started in a potentially not-logged-in state and you may have to call <tt class="code docutils literal"><span class="pre">navigator.id.request()</span></tt> to trigger a login.</p>
<p><tt class="code docutils literal"><span class="pre">appName</span></tt>: this is the name of your app.  This is important only if your domain has multiple distinct apps.</p>
</div>
<div class="section" id="sync-object">
<h2>Sync object<a class="headerlink" href="#sync-object" title="Permalink to this headline">¶</a></h2>
<p>The object returned as some methods:</p>
<p><tt class="code docutils literal"><span class="pre">lastSyncTime()</span></tt>: returns the timestamp (milliseconds) of the last successful sync.</p>
<p><tt class="code docutils literal"><span class="pre">scheduleImmediately()</span></tt>: try to do a sync right away.</p>
<p><tt class="code docutils literal"><span class="pre">resetSchedule()</span></tt>: reset the period polling to a normal pace.</p>
<p><tt class="code docutils literal"><span class="pre">scheduleSlowly()</span></tt>: slow down the polling.</p>
<p><tt class="code docutils literal"><span class="pre">activate()/deactivate()</span></tt>: activate or deactivate the scheduler. Before you retire a sync object you should call <tt class="code docutils literal"><span class="pre">sync.deactivate()</span></tt>. The scheduler is automatically activated on startup.  The polling frequency is automatically adjusted based on whether the tab is in the background or not.</p>
<p><tt class="code docutils literal"><span class="pre">request()</span></tt>: ask to get authentication (this is identicaly to <tt class="code docutils literal"><span class="pre">navigator.id.request()</span></tt>)</p>
<p><tt class="code docutils literal"><span class="pre">logout()</span></tt>: get rid of all authentication information.</p>
<p><tt class="code docutils literal"><span class="pre">toggleLogin()</span></tt>: if logged in, then log out.  If logged out, then request login.</p>
<p><tt class="code docutils literal"><span class="pre">watch(options)</span></tt>: similar to <tt class="code docutils literal"><span class="pre">navigator.id.watch()</span></tt> but is called after server verification is done.  The <tt class="code docutils literal"><span class="pre">onlogin</span></tt> method is called with <tt class="code docutils literal"><span class="pre">onlogin(email,</span> <span class="pre">completeData)</span></tt> (not an assertion).  Note this uses cached credentials, unlike <tt class="code docutils literal"><span class="pre">navigator.id.watch()</span></tt>.</p>
<p><tt class="code docutils literal"><span class="pre">reset(callback)</span></tt>: forgets all information about synchronization. This doesn&#8217;t get rid of anything on the server, but does cause the next sync to start from scratch.</p>
<p><tt class="code docutils literal"><span class="pre">authentiateUrl(url)</span></tt>: takes a URL (for a <tt class="docutils literal"><span class="pre">blob.href</span></tt>) and adds authenticating information to it.</p>
</div>
</div>
<div class="section" id="protocol">
<h1>Protocol<a class="headerlink" href="#protocol" title="Permalink to this headline">¶</a></h1>
<div class="section" id="expectations">
<h2>Expectations<a class="headerlink" href="#expectations" title="Permalink to this headline">¶</a></h2>
<p>The model of sync is a stream of updates.  All clients both put their local updates into this stream, and read the collective stream. Everything has to be represented as a concrete item in the stream, meaning that delete actions are also present in the stream.</p>
<p>There is no conflict resolution, so clients must make sure they do not overwrite each other&#8217;s updates.  If a conflict cannot be resolved without interaction (e.g., simple overwrite is not considered acceptable, and automatic merging is not possible) then it must be possible to represent the conflicted state directly, and at some point some client can resolve the conflict (possibly with user interaction) and put the unconflicted object into the stream.</p>
<p>The stream is ordered, along a single timeline.  The timeline markers should <em>not</em> be seen as based on any time or clock, as this leads to confusion and it&#8217;s not clear whose &#8220;now&#8221; we are talking about. Instead the server has a counter, and all clients work from that counter. (The counter need not be an uninterrupted stream of integers, just increasing.)</p>
<p>All interaction between client and server should happen without user intervention.  Everything is expected to be highly asynchronous, and the server may reject requests or be unavailable for short periods of time, and this should not affect user experience.</p>
<p>We expect for a new client to be able to create a good-enough duplicate of the data in other clients.  &#8220;Good-enough&#8221; because some data might be kept by clients but expired by the server because it was marked as not being permanently interesting.</p>
<p><strong>TODO:</strong> For &#8220;known&#8221; datatypes the sync server ensures the integrity of data, according to the most up-to-date notion of correctness for the data type.  As such the sync server must be updated frequently, but clients will be protected from some other rogue clients. (&#8216;&#8217;&#8216;Note:&#8217;&#8216;&#8217; not sure if this is a practical expectation?)</p>
<p>We&#8217;ll go out-of-order time-wise, and forget about authentication for now.</p>
<p>Everything happens at a single URL endpoint, we&#8217;ll call it <tt class="docutils literal"><span class="pre">/USER</span></tt></p>
</div>
<div class="section" id="objects">
<h2>Objects<a class="headerlink" href="#objects" title="Permalink to this headline">¶</a></h2>
<p>Each object looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;type_name&quot;</span><span class="p">,</span>
 <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;unique identifier among objects of this type&quot;</span><span class="p">,</span>
 <span class="nx">expires</span><span class="o">:</span> <span class="nx">timestamp</span><span class="p">,</span>
 <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="nx">the</span> <span class="nx">thing</span> <span class="nx">itself</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note the <tt class="code docutils literal"><span class="pre">data</span></tt> can be any JSONable object, including a string.</p>
<p><strong>TODO:</strong> The <tt class="code docutils literal"><span class="pre">expires</span></tt> key is entirely optional, and allows the server to delete the item (if it has not otherwise been updated).</p>
<p>The <tt class="code docutils literal"><span class="pre">id</span></tt> key must be unique for the type (submitting another key by the same id means that you are overwriting that object).</p>
<p>You can also have a deleted object, which lives as an object in sync but doesn&#8217;t have any data:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;type_name&quot;</span><span class="p">,</span>
 <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;unique identifier&quot;</span><span class="p">,</span>
 <span class="nx">expires</span><span class="o">:</span> <span class="nx">timestamp</span><span class="p">,</span>
 <span class="nx">deleted</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="requests">
<h2>Requests<a class="headerlink" href="#requests" title="Permalink to this headline">¶</a></h2>
<p>You can retrieve and send updates.  The first time is simple, you just want to accept whatever the server has: can just do:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">GET</span> <span class="o">/</span><span class="nx">USER</span>
</pre></div>
</div>
<p>This returns the response document:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="nx">collection_id</span><span class="o">:</span> <span class="s2">&quot;string_id&quot;</span><span class="p">,</span>
 <span class="nx">objects</span><span class="o">:</span> <span class="p">[[</span><span class="nx">counter1</span><span class="p">,</span> <span class="nx">object1</span><span class="p">],</span> <span class="p">[</span><span class="nx">counter2</span><span class="p">,</span> <span class="nx">object2</span><span class="p">]]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="code docutils literal"><span class="pre">collection_id</span></tt> key is only in there because it was not sent with the request; it&#8217;s a kind of &#8220;hello&#8221;.</p>
<p>Subsequent requests look like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">GET</span> <span class="o">/</span><span class="nx">USER</span><span class="o">?</span><span class="nx">since</span><span class="o">=</span><span class="nx">counter2</span><span class="o">&amp;</span><span class="nx">collection_id</span><span class="o">=</span><span class="nx">string_id</span>
</pre></div>
</div>
<p>You get the objects back, but with no <tt class="code docutils literal"><span class="pre">collection_id</span></tt> (you already know it!)  If there have been no changes you get back a <tt class="docutils literal"><span class="pre">204</span> <span class="pre">No</span> <span class="pre">Content</span></tt> response.</p>
<p>If <tt class="code docutils literal"><span class="pre">objects</span></tt> is empty, you start with a counter <tt class="docutils literal"><span class="pre">0</span></tt>.</p>
<p>If the collection has changed, and your <tt class="docutils literal"><span class="pre">string_id</span></tt> doesn&#8217;t match the server anymore, then you&#8217;ll get:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="nx">collection_changed</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
 <span class="nx">collection_id</span><span class="o">:</span> <span class="s2">&quot;new_id&quot;</span><span class="p">,</span>
 <span class="nx">objects</span><span class="o">:</span> <span class="p">[[</span><span class="nx">counter1</span><span class="p">,</span> <span class="p">...],</span> <span class="p">...]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You should then forget your remembered <tt class="code docutils literal"><span class="pre">since</span></tt> value and all the updates you have sent to the server.  This signals that whatever server or data you were communicating with before is gone.</p>
<p>When you have updates you want to send, you do:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">POST</span> <span class="o">/</span><span class="nx">USER</span><span class="o">?</span><span class="nx">since</span><span class="o">=</span><span class="nx">counter2</span><span class="o">&amp;</span><span class="nx">collection_id</span><span class="o">=</span><span class="nx">string_id</span>

<span class="p">[{</span><span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;my obj1&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;thingy&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{...},</span> <span class="p">...]</span>
</pre></div>
</div>
<p>This may return a <tt class="code docutils literal"><span class="pre">collection_changed</span></tt> error, but also there may have been an update since you last retrieved objects.  This will not do! The <tt class="docutils literal"><span class="pre">since=counter2</span></tt> shows when you last did a GET. If there have been updates you get a new GET-like response:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="nx">since_invalid</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
 <span class="nx">objects</span><span class="o">:</span> <span class="p">[[</span><span class="nx">counter3</span><span class="p">,</span> <span class="nx">object</span><span class="p">]]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You should incorporate the new object (which might conflict some with your own objects, which is why we do all this!), and then resubmit the request:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">POST</span> <span class="o">/</span><span class="nx">USER</span><span class="o">?</span><span class="nx">since</span><span class="o">=</span><span class="nx">counter3</span><span class="o">&amp;</span><span class="nx">collection_id</span><span class="o">=</span><span class="nx">string_id</span>
<span class="p">...</span>
</pre></div>
</div>
<p>A successful response will be:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="nx">object_counters</span><span class="o">:</span> <span class="p">[</span><span class="nx">counter4</span><span class="p">,</span> <span class="nx">counter5</span><span class="p">,</span> <span class="p">...]}</span>
</pre></div>
</div>
<p>The counters will correspond to each item that you sent.  You should keep the highest counter as your <tt class="code docutils literal"><span class="pre">since</span></tt> value.  (<strong>Note:</strong> maybe this should include a timestamp of sorts too?)</p>
</div>
<div class="section" id="conflicts">
<h2>Conflicts<a class="headerlink" href="#conflicts" title="Permalink to this headline">¶</a></h2>
<p>We do not resolve conflicts as part of sync, and you are strongly recommended not to burden your users with conflicts as part of your sync schedule.</p>
<p>In some cases you can resolve conflicts yourself.  For instance, if the data is not very interesting, you can just choose a winner.</p>
<p>If you can&#8217;t automatically resolve the conflicts you must incorporate all your conflicting edits into a new object, and when the user at some point can attend to the object you can show them the conflicts and ask for a resolution, putting the resolved object onto the server.</p>
</div>
<div class="section" id="partial-results">
<h2>Partial Results<a class="headerlink" href="#partial-results" title="Permalink to this headline">¶</a></h2>
<p>You may not want too many results.  In this case add to your GET requests:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">GET</span> <span class="o">/</span><span class="nx">USER</span><span class="o">?</span><span class="p">...</span><span class="o">&amp;</span><span class="nx">limit</span><span class="o">=</span><span class="mi">10</span>
</pre></div>
</div>
<p>This will return at most 10 items.  The server may also choose not to return a full set of items.  In either case the result object will have <tt class="docutils literal"><span class="pre">incomplete:</span> <span class="pre">true</span></tt>.  You can make another request and get more items.</p>
</div>
<div class="section" id="typed-results">
<h2>Typed Results<a class="headerlink" href="#typed-results" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you only care about a subset of objects.  The stream can have any number of types of objects, and while a full client may handle everything a more limited client may not care about some items. In this case do:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">GET</span> <span class="o">/</span><span class="nx">USER</span><span class="o">?</span><span class="p">...</span><span class="o">&amp;</span><span class="nx">include</span><span class="o">=</span><span class="nx">type1</span><span class="o">&amp;</span><span class="nx">include</span><span class="o">=</span><span class="nx">type2</span>
</pre></div>
</div>
<p>This gives you only <tt class="docutils literal"><span class="pre">type1</span></tt> and <tt class="docutils literal"><span class="pre">type2</span></tt> objects. Instead of opting in to some objects, you can also opt-out with <tt class="docutils literal"><span class="pre">exclude=type1&amp;exclude=type2</span></tt>.</p>
<p>The response may include <tt class="docutils literal"><span class="pre">until:</span> <span class="pre">&quot;counter3&quot;</span></tt>, which might be newer than the newest item that was returned (this happens when the newest item is not of the type you requested).</p>
<p>You may also include these same filters on your POST requests; this keeps a conflict from happening even if an object of an excluded type has been added.</p>
</div>
<div class="section" id="server-failure-and-backoff">
<h2>Server Failure and Backoff<a class="headerlink" href="#server-failure-and-backoff" title="Permalink to this headline">¶</a></h2>
<p>The server may return a 503 response, with a <tt class="docutils literal"><span class="pre">Retry-After</span></tt> value. In any request it may also reply with <tt class="docutils literal"><span class="pre">X-Sync-Poll-Time</span></tt>, which is appended to a successful request but requests that you not make another request for the given time (in seconds).</p>
</div>
<div class="section" id="authentication">
<h2>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h2>
<p>Each request has to have authentication.  The authentication uses BrowserID.  To get authentication information you make a request to:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">POST</span> <span class="o">/</span><span class="nx">DB</span><span class="o">/</span><span class="nx">verify</span>

<span class="nx">assertion</span><span class="o">=</span><span class="p">...</span><span class="o">&amp;</span><span class="nx">audience</span><span class="o">=</span><span class="p">...</span>
</pre></div>
</div>
<p>This will return a JSON response that will indicate how to authenticate future requests, like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;email&quot;</span><span class="o">:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
  <span class="s2">&quot;auth&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;auth&quot;</span><span class="o">:</span> <span class="s2">&quot;auth_string&quot;</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>What is in the <tt class="docutils literal"><span class="pre">&quot;auth&quot;</span></tt> key determines what you should do to authenticate future requests.  401 responses indicate you should re-authenticate with a new assertion.</p>
</div>
</div>
<div class="section" id="clients">
<h1>Clients<a class="headerlink" href="#clients" title="Permalink to this headline">¶</a></h1>
<p>The client algorithm is to get and put updates, storing them locally. That easy?  Sure!</p>
<div class="section" id="get">
<h2>GET<a class="headerlink" href="#get" title="Permalink to this headline">¶</a></h2>
<p>The client needs to keep a record of these values:</p>
<ul class="simple">
<li>The <tt class="code docutils literal"><span class="pre">since</span></tt> counter</li>
<li>The <tt class="code docutils literal"><span class="pre">collection_id</span></tt></li>
<li>Authentication</li>
</ul>
<p>The <tt class="code docutils literal"><span class="pre">since</span></tt> counter and the <tt class="code docutils literal"><span class="pre">collection_id</span></tt> go together to point to where in the stream of updates the client is.  If the collection changes, that counter becomes meaningless, hence the <tt class="code docutils literal"><span class="pre">collection_id</span></tt> - and when you get a <tt class="code docutils literal"><span class="pre">collection_changed</span></tt> response you should forget your <tt class="code docutils literal"><span class="pre">since</span></tt> value.</p>
<p>Every time you get a response, you update the <tt class="code docutils literal"><span class="pre">since</span></tt> value if there were updates.  If <tt class="code docutils literal"><span class="pre">until</span></tt> is set on the response, use that, otherwise use the counter from the last item in <tt class="code docutils literal"><span class="pre">objects</span></tt>.  If you get no objects, no until, or a 204 No Content respones, then don&#8217;t change anything.</p>
<p>You should keep getting stuff so long as the response includes <tt class="docutils literal"><span class="pre">incomplete:</span> <span class="pre">true</span></tt>.  Also Retry-After and X-Sync-Poll-Time should inform the speed at which you make requests.</p>
</div>
<div class="section" id="post">
<h2>POST<a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h2>
<p>Once you&#8217;ve retrieved the values, then you can send your own new values.  You&#8217;ll send <tt class="docutils literal"><span class="pre">?since={since}</span></tt> just like with GET, because you must always incorporate every value before sending your own.  This ensures that anyone who adds to the sync timeline is fully aware of everything preceding.</p>
<p>The POST results, when successful, also update <tt class="code docutils literal"><span class="pre">since</span></tt>.  And the POST results when unsuccessful look just like a GET (since you needed to do a GET, right?)</p>
</div>
<div class="section" id="quarantine">
<h2>Quarantine<a class="headerlink" href="#quarantine" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you may not understand an object you receive; its type, or the format it is in.  This might be because of corruption, but it might also be because another client has a newer/richer notion of the type than you do.</p>
</div>
<div class="section" id="blobs">
<h2>Blobs<a class="headerlink" href="#blobs" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you will want to store large amount of data with an object, for instance an image.</p>
<p>You could keep the image (encoded in some fashion, perhaps as a <tt class="docutils literal"><span class="pre">data:</span></tt> URL) stored in the objects themselves.  The problem is that clients <em>must</em> download all objects, and so the update process would requiring downloading the whole image, and would require downloading it during what might otherwise be a simple update, or before adding objects.  The sync model essentially keeps you from doing lazy fetching - something which is usually okay, but not always.</p>
<p>Instead of storing the object directly in the storage, you can POST an update with the complete blob (in addition to any metadata associated with that blob) and the blob will be stored at a separate URL.  This blob will be managed alongside the object (i.e., updated and deleted with the object).</p>
<p>To do this, use an object like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;pic1&quot;</span><span class="p">,</span>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;A picture of me and Jim&quot;</span>
  <span class="p">},</span>
  <span class="nx">blob</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">content_type</span><span class="o">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="s2">&quot;base64 encoded image&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When <tt class="code docutils literal"><span class="pre">AppData.objectsSaved()</span></tt> is called you&#8217;ll get back something like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;pic1&quot;</span><span class="p">,</span>
  <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;A picture of me and Jim&quot;</span>
  <span class="p">},</span>
  <span class="nx">blob</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">content_type</span><span class="o">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
    <span class="nx">href</span><span class="o">:</span> <span class="s2">&quot;http://storage/sync/domain/user/+static/4jD19Fde-D134&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The URL will still be protected by authentication.  To use the URL you must do <tt class="docutils literal"><span class="pre">url</span> <span class="pre">=</span> <span class="pre">sync.authenticateUrl(object.blob.href)</span></tt></p>
<p>If you make an update you can (and must!) keep the <tt class="docutils literal"><span class="pre">blob:</span> <span class="pre">{content_type:</span> <span class="pre">...,</span> <span class="pre">href:</span> <span class="pre">...}</span></tt> portion of the object; however, you do not need to upload new blob data with each update.</p>
<p>Note the URL will be controlled by CORS headers, so you can access its content with an XMLHttpRequest.</p>
</div>
</div>
<div class="section" id="to-do">
<h1>To Do<a class="headerlink" href="#to-do" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Implement periodic garbage collection</li>
<li>Move static file hosting to another domain (though that&#8217;s more of a deployment concern).</li>
<li>Allow public blobs</li>
<li>Allow first sync to go from most-recent to oldest, instead of the other way around</li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Quick Start</a></li>
<li><a class="reference internal" href="#library">Library</a><ul>
<li><a class="reference internal" href="#appdata">appData</a><ul>
<li><a class="reference internal" href="#appdata-getpendingobjects-callback"><tt class="code docutils literal"><span class="pre">appData.getPendingObjects(callback)</span></tt></a></li>
<li><a class="reference internal" href="#appdata-objectssaved-objects"><tt class="code docutils literal"><span class="pre">appData.objectsSaved(objects)</span></tt></a></li>
<li><a class="reference internal" href="#appdata-objectsreceived-objects"><tt class="code docutils literal"><span class="pre">appData.objectsReceived(objects)</span></tt></a></li>
<li><a class="reference internal" href="#appdata-status-message"><tt class="code docutils literal"><span class="pre">appData.status(message)</span></tt></a></li>
<li><a class="reference internal" href="#appdata-resetsaved"><tt class="code docutils literal"><span class="pre">appData.resetSaved()</span></tt></a></li>
<li><a class="reference internal" href="#appdata-reportobjecterrors"><tt class="code docutils literal"><span class="pre">appData.reportObjectErrors()</span></tt></a></li>
<li><a class="reference internal" href="#appdata-onupdate"><tt class="code docutils literal"><span class="pre">appData.onupdate</span></tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#options">options</a></li>
<li><a class="reference internal" href="#sync-object">Sync object</a></li>
</ul>
</li>
<li><a class="reference internal" href="#protocol">Protocol</a><ul>
<li><a class="reference internal" href="#expectations">Expectations</a></li>
<li><a class="reference internal" href="#objects">Objects</a></li>
<li><a class="reference internal" href="#requests">Requests</a></li>
<li><a class="reference internal" href="#conflicts">Conflicts</a></li>
<li><a class="reference internal" href="#partial-results">Partial Results</a></li>
<li><a class="reference internal" href="#typed-results">Typed Results</a></li>
<li><a class="reference internal" href="#server-failure-and-backoff">Server Failure and Backoff</a></li>
<li><a class="reference internal" href="#authentication">Authentication</a></li>
</ul>
</li>
<li><a class="reference internal" href="#clients">Clients</a><ul>
<li><a class="reference internal" href="#get">GET</a></li>
<li><a class="reference internal" href="#post">POST</a></li>
<li><a class="reference internal" href="#quarantine">Quarantine</a></li>
<li><a class="reference internal" href="#blobs">Blobs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#to-do">To Do</a></li>
</ul>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
    	<li><a href="#">The Cut-Out</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Ian Bicking.
    </div>
  </body>
</html>