    >>> import urlparse
    >>> from logdb.balancing import level5
    >>> from logdb.balancing.forwarder import rooted
    >>> import os, shutil
    >>> if os.path.exists('./tmp-data'):
    ...     shutil.rmtree('./tmp-data')
    >>> balance_app = app = level5.Application(preload=10, preload_dir='./tmp-data')
    >>> app = rooted(app)
    >>> from webob.dec import wsgify
    >>> @wsgify.middleware
    ... def set_remote_user(req, app, username):
    ...     req.environ['REMOTE_USER'] = username
    ...     return app
    >>> app = set_remote_user(app, username='a@b/c')
    >>> from webob import Request
    >>> def make_req(name, **kw):
    ...     url = urlparse.urljoin('http://localhost/c/a@b/', name)
    ...     return Request.blank(url, **kw)
    >>> print make_req('1')
    GET /c/a@b/1 HTTP/1.0...
    Host: localhost:80
    >>> print make_req('1').send(app)
    200 OK
    ...
    X-Node-Name: node-001
    ...
    {"collection_id": "...", "objects": []}
    >>> print make_req('2').send(app)
    200 OK
    ...
    X-Node-Name: node-007
    ...
    >>> print make_req('4').send(app)
    200 OK
    ...
    X-Node-Name: node-004
    ...
    >>> old_resp = make_req('4').send(app).json
    >>> balance_app.add_node('node-test', True, root=app)
    Deprecating from http://localhostnode-test/node-000
    Deprecating from http://localhostnode-test/node-001
    Deprecating from http://localhostnode-test/node-002
    Deprecating from http://localhostnode-test/node-003
    Deprecating from http://localhostnode-test/node-004
      deprecated: /c/a@b/4
    Deprecating from http://localhostnode-test/node-005
    Deprecating from http://localhostnode-test/node-006
    Deprecating from http://localhostnode-test/node-007
      deprecated: /c/a@b/2
    Deprecating from http://localhostnode-test/node-008
    Deprecating from http://localhostnode-test/node-009
    Copying database /c/a@b/4 from node-004
      copied 30 bytes
      deleted
    Copying database /c/a@b/2 from node-007
      copied 30 bytes
      deleted
    done.
    >>> print make_req('4').send(app)
    200 OK
    ...
    X-Node-Name: node-test
    ...
    >>> new_resp = make_req('4').send(app).json
    >>> new_resp['collection_id'] == old_resp['collection_id']
    True
    >>> print make_req('4').send(app)
    200 OK
    ...
    X-Node-Name: node-test
    ...
    >>> old_resp = make_req('1').send(app).json
    >>> balance_app.remove_node('node-001', root=app)
    Disabling node node-001
    Sending /c/a@b/1 to node node-002
      success, deleting
    >>> print make_req('1').send(app)
    200 OK
    ...
    X-Node-Name: node-002
    ...
    >>> new_resp = make_req('1').send(app).json
    >>> new_resp['collection_id'] == old_resp['collection_id']
    True
    >>> req = make_req('1', method='POST', json=[1, 2, 3])
    >>> print req
    POST /c/a@b/1 HTTP/1.0...
    Content-Length: 7...
    Host: localhost:80...
    <BLANKLINE>
    [1,2,3]
    >>> print req.send(app)
    200 OK
    ...
    X-Node-Name: node-002
    ...
    {"object_counters": [1, 2, 3], "collection_id": "..."}
    >>> print make_req('1').send(app).json
    {u'collection_id': u'...', u'objects': [[1, 1], [2, 2], [3, 3]]}
    >>> node2 = make_req('/node-002/c/a@b/1').send(app).json
    >>> print node2
    {u'collection_id': u'...', u'objects': [[1, 1], [2, 2], [3, 3]]}
    >>> node9 = make_req('/node-009/c/a@b/1').send(app).json
    >>> print node9
    {u'collection_id': u'...', u'objects': [[1, 1], [2, 2], [3, 3]]}
    >>> node9 == node2
    True
